%title Histogram Equalization
= Histogram Equalization =

== 随机变量函数的概率密度函数 ==
    对于任意的严格单调函数$g(x)$，随机变量$X$和随机变量$Y=g(X)$的概率密度函数之间有什么关系为：$f_Y(y) = f_X(g^{-1}(y)) \left| \frac{dg^{-1}(y)}{dy} \right|$，为什么呢？？？
	
如果$X$是一个随机变量，函数$Y = g(X)$是一个严格单调函数（保证了一一映射）。

由于随机变量的函数也是随机变量，所以$Y$也是一个随机变量，那么随机变量$X$的概率密度函数和随机变量$Y$的概率密度函数之间有什么关系呢？



=== 如果$g(x)$是严格单调递增函数 ===
1. $F_Y(y) = P\{Y \le y\} = P\{g(X) \le y\} = P\{X \le g^{-1}(y)\} = F_X(g^{-1}(y))$
	- 简单来说就是：$P\{Y \le y\} = P\{ X \le g^{-1}(y)\}$，其中$x = g^{-1}(y)$是$y = g(x)$的反函数。
	- 意思就是说：映射之后集合$Y$中有多少元素`小于等于`$y$，等价于经过$Y = g(X)$映射之前，集合$X$中有多少个元素`小于等于`$x = g^{-1}(y)$
		- 因为映射$Y = g(X)$是单调递增函数
		- 单调递增函数是：$x_1 < x_2$，那么有$g(x_1) < g(x_2)$
	- 举个例子，$\{6, 7, 8, 9, 10\} = g(\{1, 2, 3, 4, 5\})$，那么$P\{Y \le 8\} = P\{X \le 3\}$，其中$x = g^{-1}(y) = g^{-1}(8) = 3$
	- 上面的例子是离散的情况下，连续的情况自行脑补。
2. 两边同时对$y$求导后，得到$\ f_Y(y) = f_X(g^{-1}(y)) \frac{dg^{-1}(y)}{dy}$

=== 如果$g(x)$是严格单调递减函数 ===
1. $F_Y(y) = P\{Y \le y\} = P\{g(X) \le y\} = P\{X \ge g^{-1}(y)\} = 1 - P\{X \lt g^{-1}(y)\} = 1 - F_X(g^{-1}(y))$
	- 简单来说就是：$P\{Y \le y\} = 1- P\{ X \ge g^{-1}(y)\}$
	- 意思就是说：映射之后集合$Y$中有多少元素`小于等于`$y$，等价于经过$Y = g(X)$映射之前，集合$X$中有多少个元素`大于等于`$x = g^{-1}(y)$
		- 因为映射$Y = g(X)$是单调递减函数
		- 单调递增函数是：$x_1 < x_2$，那么有$g(x_1) > g(x_2)$
	- 举个例子，$\{10, 9, 8, 7, 6\} = g(\{1, 2, 3, 4, 5\})$，
	那么$\frac{\left|\{6, 7, 8\} \right|}{\left|\{1,2,3,4,5\}\right|} = P\{Y \le 8\} = P\{X \ge 3\} = \frac{\left|\{5,4,3\}\right|}{\left|\{1,2,3,4,5\}\right|} = 1 - P\{X \lt 3\} = 1 - \frac{\left|\{1,2\}\right|}{\left|\{1,2,3,4,5\}\right|} $
	- 上面的例子是离散的情况下，连续的情况自行脑补。
2. 两边同时对$y$求导后得到$\ f_Y(y) = - f_X(g^{-1}(y)) \frac{dg^{-1}(y)}{dy} = f_X(g^{-1}(y)) \left| \frac{dg^{-1}(y)}{dy} \right|$
	- 因为$g(x)$是递减函数，所以$g^{-1}(y)$也是递减函数，所以其导数是负的
	- 所以加上绝对值与前面的负号正好抵消

----
综合上述的两种情况，对于任意的严格单调函数$g(x)$，随机变量$X$和随机变量$Y=g(X)$的PDF之关系为：$f_Y(y) = f_X(g^{-1}(y)) \left| \frac{dg^{-1}(y)}{dx} \right|$


参考自：[[https://www.zhihu.com/question/37594200/answer/170371569|请问两个一一映射的变量的概率密度函数有什么关系，怎么证明？]]

=== 举个例子 ===
设随机变量$X$的概率密度函数为$f_X(X)$，令映射函数为单调函数$Y = X^2$，该函数在区间$[0, +\infty]$上严格单调递增。那么如何求随机变量$Y$的概率密度函数呢？？？

* 由于$y = x^2$，所以其反函数为：$g^{-1}(y) = y^{\frac{1}{2}}$
* 求导之后得$\frac{dg^{-1}(y)}{dx} = \frac{1}{2} y^{- \frac{1}{2}}$

根据公式$f_Y(y) = f_X(g^{-1}(y)) \left| \frac{dg^{-1}(y)}{dy} \right|$，那么有
* $f_Y(y) = f_X(g^{-1}(y)) \left| \frac{dg^{-1}(y)}{dy} \right| = f_X(y^{\frac{1}{2}}) \frac{1}{2} y^{- \frac{1}{2}}$

假设随机变量$X$服从区间$[0,2]$上的均匀分布
\begin{cases}
\frac{1}{2},0 \le x \le 2 \\
0, other
\end{cases}


那么随机变量$Y$的概率密度函数为
\begin{cases}
\frac{1}{4} y^{- \frac{1}{2}},0 \le y \le 4 \\
0, other
\end{cases}

----
下面来验证一下求得对不对

* 对于$x = 1$，那么经过映射之后，$y = 1$，所以应该有$F_X(1) = F_Y(1)$。
	- $\int _{0}^{1} f_X(x) dx = \int _{0}^{1} \frac{1}{2} dx = [\frac{1}{2}x]_{0}^{1} = \frac{1}{2}$
	- $\int _{0}^{1} f_Y(y) dy = \int _{0}^{1} \frac{1}{4} y^{-\frac{1}{2}} dx = [\frac{1}{2}y^{\frac{1}{2}}]_{0}^{1} = \frac{1}{2}$
* 对于$x = \sqrt 2$，那么经过映射之后，$y = 2$，所以应该有$F_X(\sqrt 2) = F_Y(2)$。
	- $\int _{0}^{\sqrt 2} f_X(x) dx = \int _{0}^{\sqrt 2} \frac{1}{2} dx = [\frac{1}{2}x]_{0}^{\sqrt 2} = \frac{1}{2} \sqrt 2$
	- $\int _{0}^{2} f_Y(y) dy = \int _{0}^{2} \frac{1}{4} y^{-\frac{1}{2}} dx = [\frac{1}{2}y^{\frac{1}{2}}]_{0}^{2} = \frac{1}{2} \sqrt 2$
* 对于$x = 2$，那么经过映射之后，$y = 4$，所以应该有$F_X(2) = F_Y(4)$。
	- $\int _{0}^{2} f_X(x) dx = \int _{0}^{2} \frac{1}{2} dx = [\frac{1}{2}x]_{0}^{2} = 1$
	- $\int _{0}^{4} f_Y(y) dy = \int _{0}^{4} \frac{1}{4} y^{-\frac{1}{2}} dx = [\frac{1}{2}y^{\frac{1}{2}}]_{0}^{4} = 1$



%% 1. $F_X(x) = P(X \le x) = P\{g(X) \le g(x)\} = P(Y \le y) = F_Y(y)$
%% 	- 简单来说就是：$P(X \le x) = P(Y \le y)$，其中$y = g(x)$
%% 	- 意思就是说，映射之前集合$X$中有多少个数小于$x$，那么经过$Y = g(X)$映射之后，集中$Y$中同样也有那么多个数小于$y$，因为是映射$Y = g(X)$是单调递增函数。
%% 		- 单调递增函数是若$x_1 < x_2$，那么有$g(x_1) < g(x_2)$
%% 	- 举个例子，$\{6, 7, 8, 9, 10\} = g(\{1, 2, 3, 4, 5\})$，那么$P(X \le 3) = P(Y \le 8)$。
%% 	- 上面的例子是离散的情况下，连续的情况自行脑补。
%% 2. 两边同时对$x$求导后得到 $\ f_X(x) = f_Y(y) \frac{dy}{dx}$

%% === 如果$g(x)$是严格单调递减函数 ===
%% 1. $F_X(x) = P(X \le x) = P\{g(X) \ge g(x)\} = 1 - P\{g(X) \le g(x)\} = 1 - P(Y \le y) = 1 - F_Y(y)$
%% 	- 简单来说就是：$F_X(x) = P(X \le x) = P(Y \ge y) = 1 - P(Y \le y) = 1 - F_Y(y)$
%% 	- 意思就是说，映射之前集合$X$中有多少个数`小于`$x$，那么经过$Y = g(X)$映射之后，集中$Y$中同样也有那么多个数`大于`$y$，因为是映射$Y = g(X)$是单调`递减`函数。
%% 		- 单调递减函数是若$x_1 < x_2$，那么有$g(x_1) > g(x_2)$
%% 	- 举个例子，$\{6, 7, 8, 9, 10\} = g(\{1, 2, 3, 4, 5\})$，那么$\frac{\left|\{1, 2, 3\} \right|}{\left|\{1, 2, 3, 4, 5\}\right|} = P(X \le 3) = P(Y \ge 8) = \frac{\left|\{10, 9, 8\} \right|}{\left|\{6, 7, 8, 9, 10\}\right|}$。
%% 	- 上面的例子是离散的情况下，连续的情况自行脑补。
%% 2. 两边同时对$x$求导后得到 $\ f_X(x) = - f_Y(y) \frac{dy}{dx} = f_Y(y) \left| \frac{dy}{dx} \right|$



%% ----
%% 综合上述的两种情况，对于任意的严格单调函数$g(x)$，随机变量$X$和随机变量$Y=g(X)$的PDF之间都有下述关系：

%% $$
%% \ f_X(x) = f_Y(y) \left| \frac{dy}{dx} \right|
%% $$



%% 参考自：[[https://www.zhihu.com/question/37594200/answer/170371569|请问两个一一映射的变量的概率密度函数有什么关系，怎么证明？]]

=== 进一步的思考 ===
函数$y = g(x)$和函数$x = g^{-1}(y)$是互为反函数的，也就是$y$是$x$的函数，$x$也是$y$的函数，关键看怎么用：
* 如果把$x = g^{-1}(y)$看做是反函数，那么有
	- $f_Y(y) = f_X(x) \left|\frac{dx}{dy} \right|$
	- 此时，上式中的$x$都是$x = g^{-1}(y)$，所以$\frac{dx}{dy} = \frac{dg^{-1}(y)}{dy}$
* 如果把$y = g(x)$看做是反函数，那么有
	- $f_X(x) = f_Y(y) \left|\frac{dy}{dx} \right|$
	- 此时，上式中的$y$都是$y = g(x)$，所以$\frac{dy}{dx} = \frac{dg(x)}{dx}$


下面在已知$y = x^2$、$x = y^{\frac{1}{2}}$和$f_X(x) = \frac{1}{2}$服从$[0,2]$上的均匀分布的基础上，分别用上面所说的两种方式进行$f_Y(y)$的推导
----
*  $f_Y(y) = f_X(x) \left|\frac{dx}{dy} \right| = f_X(y^\frac{1}{2}) \frac{1}{2} y^{-\frac{1}{2}} = \frac{1}{4}y^{-\frac{1}{2}}$
*  $f_X(x) = f_Y(y) \left|\frac{dy}{dx} \right| = f_Y(y)2x$，请记住，不管是哪种方式，要推导的都是$Y$的概率密度函数$f_Y(y)$，所以推导中的$x$都要用$y$来代替
	- $f_X(y^{\frac{1}{2}}) = f_Y(y) 2 y^{\frac{1}{2}}$
	- $f_Y(y) = f_X(y^{\frac{1}{2}}) \frac{1}{2} y^{-\frac{1}{2}} = \frac{1}{4}y^{-\frac{1}{2}}$


== 直方图均值化 ==

    如果一张图片太亮或者太暗了，那么其灰度值的直方图分布会偏右（太亮）或者偏左（太暗），直方图均值化可以帮助我们延展这个分布，这样可以更好地利用0~255的整个灰度值范围，而不仅仅是使用较亮或者较暗部分的值。 这样做的结果是增大了对比度，利用了更多的灰度值来表示图像，那么更容易观察到图像的某些细节。

我们需要找到一个变换$Y = T(X)$，使得：
1. $T(X)$在区间$[0, L - 1]$上的单调递增函数
2. 当$0 \le x \le L - 1$时，$0 \le T(x) \le L - 1$
=== 灰度值连续的情况 ===
要求一个变换$Y = T(X)$，使得经过变换之后的灰度值$Y$的概率密度函数是$[0, L - 1]$上的均匀分布。

而灰度值$X$的概率密度函数也是已知的，所以是在已知两个概率密度函数的情况下，求这个变换$Y = T(X)$

由上面的推导可知，有两种推导方式
1. $f_Y(y) = f_X(x)\left| \frac{dx}{dy} \right| = f_X(x) \left| \frac{dT^{-1}(y)}{dy} \right|$
	- 我们要求的是变换$Y = T(X)$，而不是其反变换，所以不考虑这种推导方式
2. $f_X(x) = f_Y(y)\left| \frac{dy}{dx} \right| = f_Y(y) \left| \frac{dT(x)}{dx} \right|$
	- 已知$f_Y(y)$是均匀分布，所以有$f_X(x) = \frac{1}{L - 1} \left| \frac{dT(x)}{dx} \right|$
	- $f_X(x) \left| \frac{dx}{dT(x)} \right| = \frac{1}{L - 1}$
	- 也就说，$\left| \frac{dx}{dT(x)} \right|$应该等于$\left| \frac{1}{(L-1)f_X(x)} \right|$，$f_X(x) \left| \frac{dx}{dT(x)} \right| = f_X(x) \left| \frac{1}{(L-1)f_X(x)} \right|= \frac{1}{L - 1}$，因为概率密度函数是非负的，所以可以去掉绝对值符号
	- $\frac{dT(x)}{dx} = (L-1)f_X(x)$，由微积分基本定理可知$T(x) = (L-1)\int_0^x f_X(w) dw$


    所以直方图均值化的灰度值转换公式为$y = T(x) = (L-1)\int_0^x f_X(w) dw$，这个公式的意义是如果一个灰度值的累积概率密度$\int_0^x f_X(w) dw$越大，那么其转换之后的灰度值也应该越靠后，因为乘以了$L-1$
=== 灰度值离散的情况 ===
图片的灰度值是离散的，所以需要把上面积分的形式，改为离散求和的形式

一幅图像中，灰度值$x_k$出现的概率为$p_X(x_k) = \frac{n_k}{MN}$，其中$MN$是图像中的像素总数，$n_k$是灰度为$x_k$的像素个数

    与$x_k$相对的$p_X(x_k)$图形通常称为`直方图`
$y_k = T(x_k) = (L - 1)\sum_{j=0}^{k}p_X(x_j) = \frac{L-1}{MN} \sum_{j=0}^{k} n_j$

    所以离散情况下的公式为：$y_k = T(x_k) = \frac{L-1}{MN} \sum_{j=0}^{k} n_j, \;\;\; k = 0,1,\dots,L-1$


=== 举个例子 ===


[[local:./resources/直方图均值化例子.png|{{local:./resources/直方图均值化例子.png|直方图均值化例子图片|style="width:800px; height:500px;"}}]]

右边的4条曲线表示左边从上至下的4幅图片的转换函数
1. 第1幅图片太暗了，所以其转换函数的定义域很靠左
2. 第2幅图片太亮了，所以其转换函数的定义域很靠右
3. 第3幅图片太模糊了，像素值都集中在中间
4. 第4幅图片本身就很好，所以其转换函数的斜率接近1，几乎就是一个恒等变换

可以看到转换函数的值域都是[0,255]

这几个转换的值域都是[0,255]，但不是所有的变换都是，比如如果输入图像的灰度值为0的像素很多，那么求出来的变换的值域就不是[0,255]



== 参考 ==
1. [[https://www.zhihu.com/question/37594200/answer/170371569|请问两个一一映射的变量的概率密度函数有什么关系，怎么证明？]]
2. [[http://blog.csdn.net/xiajun07061225/article/details/6910129|【数字图像处理】直方图均衡化详解及编程实现]]
